<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <!-- Título del email dinámico según el ID del pedido -->
    <title>Gracias por tu compra — Pedido #<%= order.id %></title>
    <!-- Estilos limpios y responsivos para email -->
    <style>
        body { font-family: 'Montserrat', Arial, sans-serif; background:#fafafa; color:#333; margin:0; padding:0px; }
        .container { max-width:700px; margin:0 auto; background:#fff; padding:0px; }
        .header { display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #222; padding-bottom:12px; margin-bottom:18px; }
        .logo { font-family: 'Playfair Display', serif; font-size:30px; color:#e91e63; font-weight:700; margin-left: auto; margin-right: auto;}
        h1 { font-family:'Playfair Display', serif; font-size:20px; margin:12px 0; color:#222; text-align: center; }
        .section-title { font-weight:700; color:#222; margin:10px 0 8px; font-size:15px; text-transform:uppercase; letter-spacing:0.6px; border-bottom: 1px solid #e91e63; }
        .grid { display:flex; gap:12px; flex-wrap:wrap; }
        .col { flex:1; min-width:180px; }
        p { margin:6px 0; font-size:14px; line-height:1.35; color:#444; }
        .items { margin-top:12px; }
        .item { display:flex; gap:12px; align-items:center; background:#efefef; border-radius:8px; padding:10px; margin-bottom:10px; }
        .item-info { flex:1; }
        .item-info strong { display:block; color:#e91e63; margin-bottom:4px; }
        .item-meta { font-size:12px; color:#666; margin-top:4px; }
        .summary { text-align:right; margin-top:12px; }
        .total { display:inline-block; background:#fdeef2; color:#e91e63; padding:10px 14px; border-radius:8px; font-weight:700; font-size:16px; }
        .cta { display:inline-block; margin-top:12px; text-decoration:none; background:#e91e63; color:#fff; padding:10px 14px; border-radius:8px; }
        .footer { margin-top:24px; border-top:3px solid #222; padding-top:18px; font-size:12px; color:#888; text-align:center; }
        @media (max-width:520px){ .header{flex-direction:column; align-items:flex-start} .meta{ text-align:left; margin-top:8px } .grid{flex-direction:column} }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header del email con logo -->
        <div class="header">
            <div class="logo">ShopBrands</div>
        </div>

        <!-- Mensaje principal de agradecimiento -->
        <h1>¡Gracias por tu compra!</h1>
        <p>Hola <%= order.user.first_name %>, hemos recibido tu pedido <strong>#<%= order.id %></strong> y se está procesando, recibirás un email cuando se envíe.</p>
        <p>A continuación encontrarás los detalles.</p>

        <!-- Sección: Información del pedido -->
        <div class="section-title">Información del pedido</div>
        <div class="grid">
            <!-- Columna: contacto del cliente -->
            <div class="col">
                <strong>Contacto</strong>
                <p><%= order.address?.full_name || '-' %></p>
                <p><%= order.user?.email || '-' %></p>
                <p><%= order.address?.phone || '-' %></p>
            </div>
            <!-- Columna: dirección de envío -->
            <div class="col">
                <strong>Dirección de envío</strong>
                <p><%= order.address?.street || '-' %></p>
                <p><%= [order.address?.city, order.address?.province].filter(Boolean).join(', ') %></p>
                <p><%= [order.address?.postal_code, order.address?.country].filter(Boolean).join(', ') %></p>
            </div>
            <!-- Columna: información de pago -->
            <div class="col">
                <strong>Método de pago</strong>
                <p><%= order.payments && order.payments.length>0 ? order.payments[0].method_label : '-' %></p>
                <strong style="margin-top:8px; display:block;">Estado del pago</strong>
                <p><%= order.payments && order.payments.length>0 ? order.payments[0].status_label : '-' %></p>
            </div>
        </div>

        <!-- Sección: resumen de items -->
        <div class="section-title" style="margin-top:14px;">Resumen del pedido</div>
        <div class="items">
        <% (order.items || []).forEach(function(item){ %>
            <div class="item">
                <div class="item-info">
                    <strong><%= item.product_name || item.name %></strong>
                    <div class="item-meta">
                        <span>Talla: <%= item.size || '-' %></span> &nbsp;|&nbsp;
                        <span>Color: <%= item.color || '-' %></span> &nbsp;|&nbsp;
                        <span>Cantidad: <%= item.quantity %></span>
                    </div>
                    <div style="display: flex; gap: 5px; font-size: 13px;">
                        Precio unidad: <strong style="color:#333; margin-left: 3px;"><%= Number(item.price).toFixed(2) %>€</strong>
                    </div>
                </div>
                <div style="text-align:right; min-width:110px;">
                    <div style="font-size:14px; color:#333;">Total</div>
                    <div style="font-weight:700; color:#e91e63;"><%= (Number(item.price) * Number(item.quantity)).toFixed(2) %>€</div>
                </div>
            </div>
        <% }) %>
        </div>

        <!-- Sección: resumen total y descuentos -->
        <div class="summary" style="text-align:right; font-size:16px; font-weight:700; color:#e91e63; padding:10px 15px; background:#fdeef2; border-radius:8px; margin-top:10px;">
            <% 
                // calcular subtotal sumando items
                let subtotal = 0;
                (order.items || []).forEach(function(i){ subtotal += (Number(i.price) * Number(i.quantity)); });
                const discount = order.discount_amount ? Number(order.discount_amount) : 0;
                const totalPaid = (order.total_paid ?? order.total ?? subtotal);
            %>

            <div style="text-align:right; margin-bottom:8px;">
                <div style="color:#666; font-size:14px;">Subtotal: <strong style="color:#333;"><%= subtotal.toFixed(2) %>€</strong></div>
                <% if (discount && discount > 0) { %>
                    <div style="color:#666; font-size:14px;">Descuento cupón: <strong style="color:#0b8043;">-<%= discount.toFixed(2) %>€</strong></div>
                <% } %>
                <div style="margin-top:10px; font-size:16px; color:#e91e63;"><strong>Total del pedido: <%= totalPaid.toFixed(2) %>€</strong></div>
            </div>
        </div>

        <!-- Footer con información de la tienda -->
        <div class="footer">
            <div>
                <p><strong>ShopBrands S.L.</strong> | CIF: B12345678</p>
                <p>Av. del Comercio 45, 08406, Madrid, España</p>
            </div>
            <div style="margin-top:6px;">
                Si tienes dudas escríbenos a <a href="mailto:soporte@shopbrands.com">soporte@shopbrands.com</a>
            </div>
        </div>
    </div>
</body>
</html>